{% extends 'base.html' %}
{% load static %}

{% block title %}Deleted Messages - Telegram Analyzer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'telegram_functionality/css/deleted_messages.css' %}">
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-trash text-danger"></i> Deleted Messages</h2>
            <p class="text-muted mb-0">{{ total_deleted }} deleted messages found</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'telegram:check_deleted' %}" class="btn btn-warning">
                <i class="bi bi-search"></i> Check for Deleted
            </a>
            <a href="{% url 'telegram:chats' %}" class="btn btn-outline-secondary">
                <i class="bi bi-chat-dots"></i> Chats
            </a>
            <a href="{% url 'telegram:dashboard' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Dashboard
            </a>
        </div>
    </div>

    <!-- Filter -->
    {% if chats_with_deleted %}
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-8">
                    <label class="form-label">Filter by Chat</label>
                    <select name="chat_id" class="form-select">
                        <option value="">All Chats</option>
                        {% for chat in chats_with_deleted %}
                        <option value="{{ chat.chat_id }}" {% if selected_chat_id == chat.chat_id|stringformat:"s" %}selected{% endif %}>
                            {{ chat.title }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-funnel"></i> Filter
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Deleted Messages List -->
    <div class="card shadow">
        <div class="card-body p-0">
            {% if deleted_messages %}
            <div class="list-group list-group-flush">
                {% for msg in deleted_messages %}
                <div class="list-group-item">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div class="d-flex align-items-start flex-grow-1">
                            <!-- Delete Icon -->
                            <div class="flex-shrink-0 me-3">
                                <div class="bg-danger rounded-circle d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                                    <i class="bi bi-trash text-white"></i>
                                </div>
                            </div>

                            <!-- Message Content -->
                            <div class="flex-grow-1 min-width-0">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <h6 class="mb-0">
                                        <a href="{% url 'telegram:chat_messages' msg.chat.chat_id %}?show_deleted=true" class="text-decoration-none">
                                            {{ msg.chat.title }}
                                        </a>
                                        {% if msg.sender_name %}
                                        <small class="text-muted fw-normal">- {{ msg.sender_name }}</small>
                                        {% endif %}
                                    </h6>
                                </div>

                                {% if msg.has_media %}
                                <span class="badge bg-secondary me-2">
                                    <i class="bi bi-file-earmark"></i> {{ msg.media_type }}
                                </span>
                                {% endif %}

                                <p class="mb-1 {% if msg.is_outgoing %}text-primary{% endif %}">
                                    {% if msg.is_outgoing %}<i class="bi bi-reply"></i> {% endif %}
                                    {{ msg.text|default:"[Media message]"|truncatechars:300 }}
                                </p>

                                <small class="text-muted">
                                    <i class="bi bi-clock"></i> Sent: {{ msg.date|date:"M d, Y H:i" }}
                                    {% if msg.deleted_at %}
                                    &bull; <span class="text-danger"><i class="bi bi-trash"></i> Deleted: {{ msg.deleted_at|date:"M d, Y H:i" }}</span>
                                    {% endif %}
                                </small>
                            </div>
                        </div>

                        <!-- Message ID -->
                        <div class="flex-shrink-0 ms-3 text-end">
                            <small class="text-muted">
                                ID: {{ msg.message_id }}
                            </small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
                <h4 class="mt-3 text-muted">No deleted messages found</h4>
                <p class="text-muted">
                    Click "Check for Deleted" to scan for messages that were deleted from Telegram.
                </p>
                <a href="{% url 'telegram:check_deleted' %}" class="btn btn-warning mt-2">
                    <i class="bi bi-search"></i> Check for Deleted Messages
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Info Card -->
    <div class="card mt-4 border-info">
        <div class="card-body">
            <h6 class="card-title text-info"><i class="bi bi-info-circle"></i> How Deletion Detection Works</h6>
            <p class="card-text small text-muted mb-0">
                When you sync your messages, they are stored in the database. Later, when you click "Check for Deleted",
                the system compares the stored messages with what's currently available on Telegram.
                Messages that exist in the database but are no longer on Telegram are marked as deleted.
            </p>
        </div>
    </div>
</div>
{% endblock %}
