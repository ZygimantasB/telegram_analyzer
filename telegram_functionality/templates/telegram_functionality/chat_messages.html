{% extends 'base.html' %}

{% block title %}{{ chat.title }} - Telegram Analyzer{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Chat Header -->
            <div class="card shadow-sm mb-3">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <a href="{% url 'telegram:chats' %}" class="btn btn-link text-secondary me-2">
                                <i class="bi bi-arrow-left"></i>
                            </a>
                            {% if chat.type == 'channel' %}
                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 45px; height: 45px;">
                                <i class="bi bi-megaphone text-white"></i>
                            </div>
                            {% elif chat.type == 'supergroup' or chat.type == 'group' %}
                            <div class="bg-success rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 45px; height: 45px;">
                                <i class="bi bi-people text-white"></i>
                            </div>
                            {% else %}
                            <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 45px; height: 45px;">
                                <i class="bi bi-person text-white"></i>
                            </div>
                            {% endif %}
                            <div>
                                <h5 class="mb-0">{{ chat.title }}</h5>
                                <small class="text-muted">
                                    {{ chat.type|title }}
                                    {% if chat.username %} &bull; @{{ chat.username }}{% endif %}
                                    {% if chat.members_count %} &bull; {{ chat.members_count }} members{% endif %}
                                </small>
                            </div>
                        </div>
                        <div class="d-flex gap-2 align-items-center">
                            <span class="badge bg-secondary">{{ total_messages }} messages</span>
                            {% if deleted_count > 0 %}
                            <span class="badge bg-danger">{{ deleted_count }} deleted</span>
                            {% endif %}
                            <a href="{% url 'telegram:sync_chat' chat_id %}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-arrow-repeat"></i> Sync
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="card mb-3">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            {% if last_synced %}
                            <small class="text-muted">Last synced: {{ last_synced|date:"M d, Y H:i" }}</small>
                            {% endif %}
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="showDeleted"
                                   {% if show_deleted %}checked{% endif %}
                                   onchange="toggleDeleted()">
                            <label class="form-check-label" for="showDeleted">Show deleted messages</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages -->
            <div class="card shadow">
                <div class="card-body p-0">
                    <div class="messages-container" id="messagesContainer">
                        {% if chat_messages %}
                        {% for msg in chat_messages reversed %}
                        <div class="message {% if msg.is_outgoing %}message-outgoing{% else %}message-incoming{% endif %} {% if msg.is_deleted %}message-deleted{% endif %}" data-msg-id="{{ msg.id }}">
                            <div class="message-bubble">
                                {% if msg.is_deleted %}
                                <div class="deleted-badge">
                                    <i class="bi bi-trash"></i> Deleted
                                </div>
                                {% endif %}

                                {% if not msg.is_outgoing and msg.sender_name %}
                                <div class="message-sender">{{ msg.sender_name }}</div>
                                {% endif %}

                                {% if msg.reply_to_msg_id %}
                                <div class="message-reply">
                                    <i class="bi bi-reply"></i> Reply to message
                                </div>
                                {% endif %}

                                {% if msg.has_media %}
                                <div class="message-media">
                                    <i class="bi bi-file-earmark"></i>
                                    <span class="text-muted">{{ msg.media_type }}</span>
                                </div>
                                {% endif %}

                                {% if msg.text %}
                                <div class="message-text">{{ msg.text|linebreaksbr }}</div>
                                {% endif %}

                                <div class="message-meta">
                                    <span class="message-time">{{ msg.date|slice:":16"|slice:"11:" }}</span>
                                    {% if msg.views %}
                                    <span class="message-views"><i class="bi bi-eye"></i> {{ msg.views }}</span>
                                    {% endif %}
                                    {% if msg.is_outgoing %}
                                    <i class="bi bi-check2-all text-primary"></i>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-chat-dots text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-3">No messages found</p>
                            <a href="{% url 'telegram:sync_chat' chat_id %}" class="btn btn-primary">
                                <i class="bi bi-arrow-repeat"></i> Sync Messages
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Pagination -->
                {% if total_pages > 1 %}
                <div class="card-footer">
                    <nav aria-label="Message pagination">
                        <ul class="pagination justify-content-center mb-0">
                            {% if page > 1 %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page|add:'-1' }}&limit={{ per_page }}{% if show_deleted %}&show_deleted=true{% endif %}">
                                    <i class="bi bi-chevron-left"></i> Previous
                                </a>
                            </li>
                            {% endif %}

                            <li class="page-item disabled">
                                <span class="page-link">Page {{ page }} of {{ total_pages }}</span>
                            </li>

                            {% if page < total_pages %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page|add:'1' }}&limit={{ per_page }}{% if show_deleted %}&show_deleted=true{% endif %}">
                                    Next <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.messages-container {
    max-height: 70vh;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
}

.message {
    max-width: 75%;
    margin-bottom: 0.75rem;
}

.message-incoming {
    align-self: flex-start;
}

.message-outgoing {
    align-self: flex-end;
}

.message-bubble {
    padding: 0.5rem 0.75rem;
    border-radius: 1rem;
    position: relative;
}

.message-incoming .message-bubble {
    background-color: #f1f3f4;
    border-bottom-left-radius: 0.25rem;
}

.message-outgoing .message-bubble {
    background-color: #dcf8c6;
    border-bottom-right-radius: 0.25rem;
}

.message-deleted .message-bubble {
    background-color: #ffebee;
    border: 1px dashed #dc3545;
}

.deleted-badge {
    font-size: 0.7rem;
    color: #dc3545;
    margin-bottom: 0.25rem;
}

.message-sender {
    font-weight: 600;
    font-size: 0.85rem;
    color: #075e54;
    margin-bottom: 0.25rem;
}

.message-text {
    word-wrap: break-word;
    white-space: pre-wrap;
}

.message-meta {
    font-size: 0.7rem;
    color: #667781;
    text-align: right;
    margin-top: 0.25rem;
}

.message-time {
    margin-right: 0.5rem;
}

.message-views {
    margin-right: 0.5rem;
}

.message-reply {
    font-size: 0.8rem;
    color: #667781;
    border-left: 3px solid #25d366;
    padding-left: 0.5rem;
    margin-bottom: 0.5rem;
}

.message-media {
    background: rgba(0,0,0,0.05);
    padding: 0.5rem;
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
}
</style>

<script>
function toggleDeleted() {
    const checkbox = document.getElementById('showDeleted');
    const url = new URL(window.location);
    if (checkbox.checked) {
        url.searchParams.set('show_deleted', 'true');
    } else {
        url.searchParams.delete('show_deleted');
    }
    url.searchParams.set('page', '1');
    window.location = url;
}
</script>
{% endblock %}
