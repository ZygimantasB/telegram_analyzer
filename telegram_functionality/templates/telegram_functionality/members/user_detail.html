{% extends 'base.html' %}

{% block title %}{{ tg_user.get_display_name }} - User Profile{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- User Profile Card -->
        <div class="col-md-4 mb-4">
            <div class="card shadow">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <div class="bg-primary rounded-circle text-white d-inline-flex align-items-center justify-content-center" style="width: 100px; height: 100px; font-size: 2.5rem;">
                            {% if tg_user.is_bot %}
                            <i class="bi bi-robot"></i>
                            {% else %}
                            <i class="bi bi-person"></i>
                            {% endif %}
                        </div>
                    </div>
                    <h4>{{ tg_user.get_display_name }}</h4>
                    {% if tg_user.username %}
                    <p class="text-muted">@{{ tg_user.username }}</p>
                    {% endif %}

                    <div class="mb-3">
                        {% if tg_user.is_bot %}<span class="badge bg-secondary">Bot</span>{% endif %}
                        {% if tg_user.is_premium %}<span class="badge bg-warning text-dark">Premium</span>{% endif %}
                        {% if tg_user.is_verified %}<span class="badge bg-info">Verified</span>{% endif %}
                        {% if tg_user.is_scam %}<span class="badge bg-danger">Scam Warning</span>{% endif %}
                        {% if tg_user.is_fake %}<span class="badge bg-danger">Fake Account</span>{% endif %}
                        {% if tg_user.is_deleted %}<span class="badge bg-dark">Deleted</span>{% endif %}
                    </div>

                    <table class="table table-sm text-start">
                        <tr>
                            <td class="text-muted">User ID</td>
                            <td class="fw-bold">{{ tg_user.user_id }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Status</td>
                            <td>
                                {% if tg_user.status == 'online' %}
                                <span class="text-success">Online</span>
                                {% elif tg_user.status == 'recently' %}
                                <span class="text-info">Recently Active</span>
                                {% elif tg_user.status == 'last_week' %}
                                <span class="text-warning">Last Week</span>
                                {% else %}
                                <span class="text-muted">{{ tg_user.status|default:"Unknown" }}</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% if tg_user.last_online %}
                        <tr>
                            <td class="text-muted">Last Online</td>
                            <td>{{ tg_user.last_online|date:"M d, Y H:i" }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td class="text-muted">First Seen</td>
                            <td>{{ tg_user.first_seen_at|date:"M d, Y" }}</td>
                        </tr>
                    </table>

                    {% if tg_user.bio %}
                    <div class="text-start mt-3">
                        <strong>Bio:</strong>
                        <p class="text-muted mb-0">{{ tg_user.bio }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Memberships -->
            <div class="card shadow mt-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-people"></i> Group Memberships</h6>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for membership in memberships %}
                        <a href="{% url 'telegram:chat_messages' membership.chat.chat_id %}" class="list-group-item list-group-item-action">
                            <div class="d-flex justify-content-between">
                                <span>{{ membership.chat.title|truncatechars:25 }}</span>
                                <span class="badge {% if membership.role == 'creator' %}bg-warning text-dark{% elif membership.role == 'admin' %}bg-primary{% else %}bg-secondary{% endif %}">
                                    {{ membership.role }}
                                </span>
                            </div>
                        </a>
                        {% empty %}
                        <div class="list-group-item text-center text-muted">
                            No group memberships found
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Stats -->
        <div class="col-md-8">
            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h3>{{ total_messages }}</h3>
                            <p class="mb-0">Total Messages</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h3>{{ memberships|length }}</h3>
                            <p class="mb-0">Groups</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h3>{{ messages_by_chat|length }}</h3>
                            <p class="mb-0">Active In</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Chart -->
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-graph-up"></i> Activity (Last 30 Days)</h6>
                </div>
                <div class="card-body">
                    <canvas id="activityChart" height="150"></canvas>
                </div>
            </div>

            <!-- Messages by Chat -->
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-chat-dots"></i> Messages by Chat</h6>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for chat in messages_by_chat %}
                        <a href="{% url 'telegram:chat_messages' chat.chat__chat_id %}" class="list-group-item list-group-item-action d-flex justify-content-between">
                            <span>{{ chat.chat__title }}</span>
                            <span class="badge bg-primary">{{ chat.count }}</span>
                        </a>
                        {% empty %}
                        <div class="list-group-item text-center text-muted">
                            No messages from this user
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Recent Messages -->
            <div class="card shadow">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-chat-left-text"></i> Recent Messages</h6>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                        {% for msg in recent_messages %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">{{ msg.chat.title }}</small>
                                <small class="text-muted">{{ msg.date|date:"M d, H:i" }}</small>
                            </div>
                            <p class="mb-0">{{ msg.text|truncatechars:200|default:"[Media]" }}</p>
                        </div>
                        {% empty %}
                        <div class="list-group-item text-center text-muted">
                            No recent messages
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const activityData = {{ daily_activity|safe }};

if (activityData.length > 0) {
    new Chart(document.getElementById('activityChart'), {
        type: 'line',
        data: {
            labels: activityData.map(d => d.day),
            datasets: [{
                label: 'Messages',
                data: activityData.map(d => d.count),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                fill: true,
                tension: 0.4,
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
} else {
    document.getElementById('activityChart').parentElement.innerHTML = '<p class="text-center text-muted py-4">No activity data available</p>';
}
</script>
{% endblock %}
